function handleCalDAVError(e,o){var l="";l=globalResourceCalDAVList.collections;for(var t=0;t<l.length;t++)if(void 0!=l[t].uid){var i=l[t].accountUID.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@([^/]+)(.*/)","i")),a=i[1]+i[3]+i[4],r=i[2];if(o.href==a&&o.userAuth.userName==r){if("event"==globalSettingsSaving&&e){var s=!1;if("undefined"!=typeof globalCrossServerSettingsURL&&null!=globalCrossServerSettingsURL&globalCrossServerSettingsURL){for(var n=l[t].uid.match(RegExp("/([^/]+/[^/]+/)$")),d=n[1].match("^(.*/)([^/]+)/$"),c=decodeURIComponent(d[1])+d[2]+"/",u=!1,h=0;h<globalSettings.loadedcalendarcollections.value.length;h++){var C=globalSettings.loadedcalendarcollections.value[h].match("^(.*/)([^/]+)/([^/]+)/$"),p=decodeURIComponent(C[2])+"/"+C[3]+"/";if(c==p){u=!0;break}}s=u}else{var n=l[t].uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")),c=n[1]+n[3];s=globalSettings.loadedcalendarcollections.value.indexOf(c)!=-1}if(s&&""==l[t].oldSyncToken){var v=$.extend(l[t],{makeLoaded:!0});globalResourceCalDAVList.insertResource(v,l[t].resourceIndex,!0),updateMainLoaderText(l[t].listType),updateMainLoader()}}e?$("#ResourceCalDAVList").find('[data-id="'+l[t].uid+'"]').addClass("r_error"):$("#ResourceCalDAVList").find('[data-id="'+l[t].uid+'"]').removeClass("r_error")}}l=globalResourceCalDAVList.TodoCollections;for(var t=0;t<l.length;t++)if(void 0!=l[t].uid){var i=l[t].accountUID.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@([^/]+)(.*/)","i")),a=i[1]+i[3]+i[4],r=i[2];if(o.href==a&&o.userAuth.userName==r){if("todo"==globalSettingsSaving&&e){var s=!1;if("undefined"!=typeof globalCrossServerSettingsURL&&null!=globalCrossServerSettingsURL&globalCrossServerSettingsURL){for(var n=l[t].uid.match(RegExp("/([^/]+/[^/]+/)$")),d=n[1].match("^(.*/)([^/]+)/$"),c=decodeURIComponent(d[1])+d[2]+"/",u=!1,h=0;h<globalSettings.loadedtodocollections.value.length;h++){var C=globalSettings.loadedtodocollections.value[h].match("^(.*/)([^/]+)/([^/]+)/$"),p=decodeURIComponent(C[2])+"/"+C[3]+"/";if(c==p){u=!0;break}}s=u}else{var n=l[t].uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")),c=n[1]+n[3];s=globalSettings.loadedtodocollections.value.indexOf(c)!=-1}if(s&&""==l[t].oldSyncToken){var v=$.extend(l[t],{makeLoaded:!0});globalResourceCalDAVList.insertResource(v,l[t].resourceIndex,!1),updateMainLoaderText(l[t].listType),updateMainLoader()}}e?$("#ResourceCalDAVTODOList").find('[data-id="'+l[t].uid+'"]').addClass("r_error"):$("#ResourceCalDAVTODOList").find('[data-id="'+l[t].uid+'"]').removeClass("r_error")}}}function unloadCalDAVCollection(e,o){var l={},t="";o?l=globalResourceCalDAVList.collections:(l=globalResourceCalDAVList.TodoCollections,t="TODO");for(var i=0;i<l.length;i++)if(void 0!=l[i].uid){var a=l[i].uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")),r=a[1]+a[3];if(e.indexOf(r)!=-1){if($("#CalendarLoader"+t).children(".loaderInfo").text(localization[globalInterfaceLanguage].unloadingCalendars),window["globalVisibleCalDAV"+t+"Collections"].indexOf(l[i].uid)!=-1&&window["globalVisibleCalDAV"+t+"Collections"].splice(window["globalVisibleCalDAV"+t+"Collections"].indexOf(l[i].uid),1),o){var s=$("#main").width()-$("#calendar").width();$("#calendar").fullCalendar("removeEventSource",l[i].fcSource);var n=$("#main").width()-$("#calendar").width();rerenderCalendar(s!=n),globalEventList.events[l[i].uid]={},globalEventList.displayEventsArray[l[i].uid]=new Array}else{var s=$("#mainTODO").width()-$("#todoList").width();$("#todoList").fullCalendar("removeEventSource",l[i].fcSource);var n=$("#mainTODO").width()-$("#todoList").width();rerenderTodo(s!=n),globalEventList.todos[l[i].uid]={},globalEventList.displayTodosArray[l[i].uid]=new Array}l[i].fcSource=null,l[i].someChanged=!1,l[i].makeLoaded=!1,l[i].syncToken="",l[i].oldSyncToken=""}}"event"!=globalSettingsSaving&&"todo"!=globalSettingsSaving||globalFirstHideLoader||setTimeout(function(){hideUnloadCollectionCallback(globalSettingsSaving)},300)}function addLoadCalDAVCollection(e,o){var l={},t="";o?l=globalResourceCalDAVList.collections:(l=globalResourceCalDAVList.TodoCollections,t="TODO");for(var i=0;i<l.length;i++)if(void 0!=l[i].uid){var a=l[i].uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")),r=a[1]+a[3];if(e.indexOf(r)!=-1&&!l[i].makeLoaded){l[i].urlArray={};var s=$("#ResourceCalDAV"+t+"List").find(".resourceCalDAV"+t+'_item[data-id="'+jqueryEscapeSelector(l[i].uid)+'"]');l[i].someChanged=!0,l[i].makeLoaded=!0;for(var n=vCalendar.pre.accountUidParts,d=l[i].accountUID.match(n),c=d[1]+d[3]+d[4],u=d[2],h=0;h<globalAccountSettings.length;h++)if(globalAccountSettings[h].href==c&&globalAccountSettings[h].userAuth.userName==u&&globalLoadedPrincipals.indexOf(c)==-1){globalLoadedPrincipals.push(globalAccountSettings[h].href);break}var C=s.prevUntil(".resourceCalDAV"+t+"_header").last().prev();C.length||(C=s.prev()),C.css("display","block"),s.css("display","");var p=s.find("input[type=checkbox]").not(".unloadCheck");p.prop("checked",!0),collectionChBoxClick(p.get(0),"#ResourceCalDAV"+t+"List",".resourceCalDAV"+t+"_header",".resourceCalDAV"+t+"_item",null,!1),window["globalVisibleCalDAV"+t+"Collections"].indexOf(l[i].uid)==-1&&window["globalVisibleCalDAV"+t+"Collections"].splice(window["globalVisibleCalDAV"+t+"Collections"].length,0,l[i].uid),l[i].newlyAdded=!0}}for(var v=new Array,i=0;i<l.length;i++)void 0!=l[i].uid&&(v[v.length]={displayValue:l[i].displayvalue,uid:l[i].uid,permissions_read_only:l[i].permissions.read_only,makeLoaded:l[i].makeLoaded});v.sort(customResourceCompare),globalResourceCalDAVList.sortedCollections=v}function ResourceCalDAVList(){this.collections=new Array,this.TodoCollections=new Array,this.calendarsLoaded=null,this.counterList=new Array,this.sortedTodoCollections=new Array,this.sortedCollections=new Array,this.reset=function(){this.TodoCollections.splice(0,this.TodoCollections.length),this.collections.splice(0,this.collections.length),this.counterList=new Array,this.sortedTodoCollections=new Array,this.sortedCollections=new Array},this.getHeaderValue=function(e){var o=new RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@([^/]+).*/([^/]*)/","i"),l=e.accountUID.match(o),t=l[3],i=l[3].replace(vCalendar.pre.numberPortRex,""),a=i.replace(vCalendar.pre.domainRex,""),r=i.match(vCalendar.pre.domainNameRex)[2],s=decodeURIComponent(l[4]),n=decodeURIComponent(l[4]).replace(vCalendar.pre.principalUserNameRex,""),d=e.userAuth.userName,c=e.userAuth.userName.replace(vCalendar.pre.loginRex,"");e.subscription||"string"==typeof e.hrefLabel&&""!=e.hrefLabel&&("%x"!=e.hrefLabel||""!=e.headervalue)?!e.subscription||"string"==typeof e.hrefLabel&&""!=e.hrefLabel||(e.hrefLabel=localization[globalInterfaceLanguage].txtSubscribed):e.hrefLabel="%d/%p [%u]";var u=e.hrefLabel;return u=u.replace(vCalendar.pre.HRex,t),u=u.replace(vCalendar.pre.hRex,i),u=u.replace(vCalendar.pre.DRex,a),u=u.replace(vCalendar.pre.dRex,r),u=u.replace(vCalendar.pre.PRex,s),u=u.replace(vCalendar.pre.pRex,n),u=u.replace(vCalendar.pre.URex,d),u=u.replace(vCalendar.pre.uRex,c),u=u.replace(vCalendar.pre.xRex,e.headervalue),e.hrefLabel=u,u},this.getSortKey=function(e,o,l){var t=new RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@([^/]+)(.*/)([^/]+/)([^/]+/)([^/]*)","i"),i=e.uid.match(t),a="";return a=e.subscription?"B":"A",1!=globalSettings.resourcealphabetsorting.value&&(a+=l.pad(String(globalAccountSettings.length).length)),a+=i[1]+i[3]+"/"+(void 0==e.hrefLabel||null==e.hrefLabel?i[5]:e.hrefLabel)+" "+e.userAuth.userName,0==o&&(a+=" "+e.displayvalue),a},this.insertResource=function(e,o,l){var t=e.hrefLabel,i=this.getHeaderValue(e);e.sortkey=this.getSortKey(e,!1,o);var a={},r="",s=!1,n=!1;l?a=this.collections:(a=this.TodoCollections,r="TODO");for(var d=0;d<a.length;d++)if(a[d].uid==e.uid){a[d].urlArray={};var c=$("#ResourceCalDAV"+r+"List").find(".resourceCalDAV"+r+'_item[data-id="'+jqueryEscapeSelector(e.uid)+'"]');if(a[d].displayvalue==e.displayvalue&&a[d].permissions.read_only==e.permissions.read_only&&a[d].headervalue==e.headervalue)return a[d]=$.extend(e,{fcSource:a[d].fcSource,syncToken:a[d].syncToken,oldSyncToken:a[d].oldSyncToken,newlyAdded:a[d].newlyAdded,forceSyncPROPFIND:a[d].forceSyncPROPFIND}),0;n=!0,$.extend(e,{fcSource:a[d].fcSource,syncToken:a[d].syncToken,oldSyncToken:a[d].oldSyncToken,newlyAdded:a[d].newlyAdded,forceSyncPROPFIND:a[d].forceSyncPROPFIND}),s=c.find("input[type=checkbox]").not(".unloadCheck").prop("checked"),this.removeResource(e.uid,!1,l);break}if(!globalCalDAVInitLoad&&!n){var u=e.uid.match(RegExp("^(https?://)([^@/]+(?:@[^@/]+)?)@(.*)")),h=u[1]+u[3],C=null,p=!1;if(C=l?globalSettings.loadedcalendarcollections.value:globalSettings.loadedtodocollections.value,"undefined"!=typeof globalCrossServerSettingsURL&&null!=globalCrossServerSettingsURL&globalCrossServerSettingsURL){for(var u=e.uid.match(RegExp("/([^/]+/[^/]+/)$")),v=u[1].match("^(.*/)([^/]+)/$"),g=decodeURIComponent(v[1])+v[2]+"/",f=!1,b=0;b<C.length;b++){var m=C[b].match("^(.*/)([^/]+)/([^/]+)/$"),y=decodeURIComponent(m[2])+"/"+m[3]+"/";if(g==y){f=!0;break}}p=f}else p=C.indexOf(h)!=-1;p?(e.makeLoaded=!0,e.newlyAdded=!0):(e.makeLoaded=!1,e.newlyAdded=!1),e.oldSyncToken="",e.someChanged=!1,s=!0}var A={headerOnly:!0,sortkey:this.getSortKey(e,!0,o),displayvalue:"%x"==t?i.replace(RegExp("^[^#]+#"),""):i,index:0},D=0,L=0,T=a.length-1;if(a.length>0)for(;L<T;){D=L+Math.round((T-L)/2);var R=(cmp_str=a[D].sortkey).customCompare(e.sortkey,globalSortAlphabet,1,!1);if(R==-1){if(D+1==a.length-1&&"undefined"!=typeof a[D+1]&&(cmp_str=a[D+1].sortkey).customCompare(e.sortkey,globalSortAlphabet,1,!1)==-1){D+=2;break}L=++D}else if(1==R){if((cmp_str=a[D-1].sortkey).customCompare(e.sortkey,globalSortAlphabet,1,!1)==-1)break;T=--D}}for(var V=1,d=0;d<a.length;d++)if(1==a[d].headerOnly&&a[d].displayvalue==A.displayvalue){V=0;break}V&&(A.index=D,a.splice(D,0,A)),1==a.length&&globalCalDAVInitLoad&&$("#SystemCalDavZAP .fc-header-center ").addClass("r_operate_all"),this.counterList[e.uid+" "+e.listType]={collectionLength:0,counter:0,uid:e.uid,isLoading:!1,isSaving:!1},a.splice(D+V,0,e),n||(l?(globalEventList.displayEventsArray[e.uid]=new Array,globalEventList.events[e.uid]={}):(globalEventList.displayTodosArray[e.uid]=new Array,globalEventList.todos[e.uid]={}));var S=".resourceCalDAV"+r+"_header",k=".resourceCalDAV"+r+"_item";if(V){var x=$("#ResourceCalDAV"+r+"ListTemplate").find(".resourceCalDAV"+r+"_header").clone().wrap("<div>");x.append(A.displayvalue),""==r?x.find("input[type=checkbox]").attr("onclick","resourceChBoxClick(this, '#'+$(this).parent().parent().attr('id'), '"+S+"', false);if(isCalDAVLoaded && $(this).parent().parent().attr('id')== 'ResourceCalDAV"+r+"List'){$(this).prop('checked')?enableResource($(this).parent()):disableResource($(this).parent());}"):x.find("input[type=checkbox]").attr("onclick","resourceChBoxClick(this, '#'+$(this).parent().parent().attr('id'), '"+S+"', false);if(isCalDAVLoaded && $(this).parent().parent().attr('id')== 'ResourceCalDAV"+r+"List'){$(this).prop('checked')?enableResourceTodo($(this).parent()):disableResourceTodo($(this).parent());}"),x.css("display","none"),x=x.parent().html(),$("#ResourceCalDAV"+r+"List").children().eq(D).after(x)}var x=$("#ResourceCalDAV"+r+"ListTemplate").find(".resourceCalDAV"+r+"_item").clone().wrap("<div>");e.uid.split("/");if(e.permissions.read_only&&x.addClass("resourceCalDAV_item_ro"),x.attr("data-id",e.uid),globalCalDAVInitLoad&&x.addClass("r_operate"),x.html("<div class='resourceCalDAVColor' style='background:"+e.ecolor+"'></div><input type='text' class='colorPicker'/><input type='checkbox' name="+e.uid+" />"+$("<div/>").text(e.displayvalue).html()),x.attr("title",$("<div/>").text(e.displayvalue).html()),""==r?x.find("input[type=checkbox]").attr({"data-id":e.uid,onclick:"var evt = arguments[0];evt.stopPropagation();collectionChBoxClick(this, '#'+$(this).parent().parent().attr('id'), '"+S+"', '"+k+"', null, false);if(isCalDAVLoaded && $(this).parent().parent().attr('id')== 'ResourceCalDAV"+r+"List'){$(this).prop('checked')?enableCalendar('"+e.uid+"'):disableCalendar('"+e.uid+"');}"}):x.find("input[type=checkbox]").attr({"data-id":e.uid,onclick:"var evt = arguments[0];evt.stopPropagation();collectionChBoxClick(this, '#'+$(this).parent().parent().attr('id'), '"+S+"', '"+k+"', null, false);if(isCalDAVLoaded && $(this).parent().parent().attr('id')== 'ResourceCalDAV"+r+"List'){$(this).prop('checked')?enableCalendarTodo('"+e.uid+"'):disableCalendarTodo('"+e.uid+"');}"}),x.click(function(e){return!!($(this).hasClass("resourceCalDAV_item")&&globalEventCollectionsLoading||$(this).hasClass("resourceCalDAVTODO_item")&&globalTodoCollectionsLoading)||(e.shiftKey&&(l?enableOne($(this).attr("data-id")):enableOneTodo($(this).attr("data-id"))),$("#ResourceCalDAV"+r+"List .resourceCalDAV_item_selected").removeClass("resourceCalDAV_item_selected"),void $(this).addClass("resourceCalDAV_item_selected"))}),"undefined"!=typeof globalCalendarColorPropertyXmlns&&null!=globalCalendarColorPropertyXmlns&&""!==globalCalendarColorPropertyXmlns&&globalCalendarColorPropertyXmlns===!1||bindColorPickerClick(x.find(".resourceCalDAVColor")),$("#ResourceCalDAV"+r+"List").children().eq(D+V).after(x),e.makeLoaded){var O=x.prevUntil(".resourceCalDAV"+r+"_header").last().prev();O.length||(O=x.prev()),O.css("display","block");for(var w=vCalendar.pre.accountUidParts,_=e.accountUID.match(w),E=_[1]+_[3]+_[4],U=_[2],d=0;d<globalAccountSettings.length;d++)if(globalAccountSettings[d].href==E&&globalAccountSettings[d].userAuth.userName==U&&globalLoadedPrincipals.indexOf(E)==-1){globalLoadedPrincipals.push(globalAccountSettings[d].href);break}}else x.css("display","none");s&&(window["globalVisibleCalDAV"+r+"Collections"].indexOf(e.uid)==-1&&window["globalVisibleCalDAV"+r+"Collections"].splice(window["globalVisibleCalDAV"+r+"Collections"].length,0,e.uid),$("#ResourceCalDAV"+r+"List").children().eq(D+V+1).find("input[type=checkbox]").prop("checked",!0)),globalCalDAVInitLoad||collectionChBoxClick(x.find("input[type=checkbox]").get(0),"#ResourceCalDAV"+r+"List",".resourceCalDAV"+r+"_header",".resourceCalDAV"+r+"_item",null,!1)},this.removeOldResources=function(e,o){for(var l=e.match(vCalendar.pre.hrefRex),t=(l[2],this.collections.length-1);t>=0;t--)if(void 0!=this.collections[t]&&!this.collections[t].subscription&&void 0!=this.collections[t].timestamp&&0==this.collections[t].uid.indexOf(e)&&this.collections[t].timestamp<o){var i=(this.collections[t].uid,$("#main").width()-$("#calendar").width());$("#calendar").fullCalendar("removeEventSource",this.collections[t].fcSource);var a=$("#main").width()-$("#calendar").width();rerenderCalendar(i!=a);var r=$("#ResourceCalDAVList").find('.resourceCalDAV_item[data-id^="'+jqueryEscapeSelector(this.collections[t].uid)+'"]'),s=r.prevUntil(".resourceCalDAV_header").last().prev();if(s.length||(s=r.prev()),r.remove(),this.collections.splice(t,1),void 0!=this.collections[t]&&1!=this.collections[t].headerOnly||1!=this.collections[t-1].headerOnly){for(var n=null,d=t-1;d>0&&1!=this.collections[d].headerOnly;d--)if(this.collections[d].makeLoaded){n=this.collections[d];break}if(null==n)for(var d=t;d<this.collections.length&&1!=this.collections[d].headerOnly;d++)if(this.collections[d].makeLoaded){n=this.collections[d];break}if(null==n)s.css("display","none");else{var c=$("#ResourceCalDAVList").find('.resourceCalDAV_item[data-id^="'+jqueryEscapeSelector(n.uid)+'"]').find("input[type=checkbox]");collectionChBoxClick(c.get(0),"#ResourceCalDAVList",".resourceCalDAV_header",".resourceCalDAV_item",null,!1)}}else s.remove(),this.collections.splice(--t,1)}for(var t=this.TodoCollections.length-1;t>=0;t--)if(void 0!=this.TodoCollections[t]&&!this.TodoCollections[t].subscription&&void 0!=this.TodoCollections[t].timestamp&&0==this.TodoCollections[t].uid.indexOf(e)&&this.TodoCollections[t].timestamp<o){var i=(this.TodoCollections[t].uid,$("#mainTODO").width()-$("#todoList").width());$("#todoList").fullCalendar("removeEventSource",this.TodoCollections[t].fcSource);var a=$("#mainTODO").width()-$("#todoList").width();rerenderTodo(i!=a);var r=$("#ResourceCalDAVTODOList").find('.resourceCalDAVTODO_item[data-id^="'+jqueryEscapeSelector(this.TodoCollections[t].uid)+'"]'),s=r.prevUntil(".resourceCalDAVTODO_header").last().prev();if(s.length||(s=r.prev()),r.remove(),this.TodoCollections.splice(t,1),void 0!=this.TodoCollections[t]&&1!=this.TodoCollections[t].headerOnly||1!=this.TodoCollections[t-1].headerOnly){for(var n=null,d=t-1;d>0&&1!=this.TodoCollections[d].headerOnly;d--)if(this.TodoCollections[d].makeLoaded){n=this.TodoCollections[d];break}if(null==n)for(var d=t;d<this.TodoCollections.length&&1!=this.TodoCollections[d].headerOnly;d++)if(this.TodoCollections[d].makeLoaded){n=this.TodoCollections[d];break}if(null==n)s.css("display","none");else{var c=$("#ResourceCalDAVTODOList").find('.resourceCalDAVTODO_item[data-id^="'+jqueryEscapeSelector(n.uid)+'"]').find("input[type=checkbox]");collectionChBoxClick(c.get(0),"#ResourceCalDAVTODOList",".resourceCalDAVTODO_header",".resourceCalDAVTODO_item",null,!1)}}else s.remove(),this.TodoCollections.splice(--t,1)}},this.removeResource=function(e,o,l){if(l){for(var t=this.collections.length-1;t>=0;t--)if(this.collections[t].uid==e){var i=(this.collections[t].uid,$("#ResourceCalDAVList").find('[data-id^="'+jqueryEscapeSelector(this.collections[t].uid)+'"]')),a=i.prev();i.remove(),this.collections.splice(t,1),(void 0==this.collections[t]||1==this.collections[t].headerOnly)&&t>0&&1==this.collections[t-1].headerOnly&&(a.remove(),this.collections.splice(t,1))}}else for(var t=this.TodoCollections.length-1;t>=0;t--)if(this.TodoCollections[t].uid==e){var i=(this.TodoCollections[t].uid,$("#ResourceCalDAVTODOList").find('[data-id^="'+jqueryEscapeSelector(this.TodoCollections[t].uid)+'"]')),a=i.prev();i.remove(),this.TodoCollections.splice(t,1),(void 0==this.TodoCollections[t]||1==this.TodoCollections[t].headerOnly)&&t>0&&1==this.TodoCollections[t-1].headerOnly&&(a.remove(),this.TodoCollections.splice(t,1))}},this.getCollectionByUID=function(e){for(var o=0;o<this.collections.length;o++)if(this.collections[o].uid==e)return this.collections[o];for(var o=0;o<this.TodoCollections.length;o++)if(this.TodoCollections[o].uid==e)return this.TodoCollections[o];return null},this.getEventCollectionByUID=function(e){for(var o=0;o<this.collections.length;o++)if(this.collections[o].uid==e)return this.collections[o];return null},this.getTodoCollectionByUID=function(e){for(var o=0;o<this.TodoCollections.length;o++)if(this.TodoCollections[o].uid==e)return this.TodoCollections[o];return null},this.getTodoCollectionAndIndexByUID=function(e){for(var o=0;o<this.TodoCollections.length;o++)if(this.TodoCollections[o].uid==e)return{coll:this.TodoCollections[o],index:o};return null},this.getResources=function(){return this.collections},this.getSyncResourceArray=function(){return this.syncResourceArray}}